<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js" ></script>

    <title>Кинотеатр</title>

    <script>
        function sendPlaces() {
            let place = $('input:radio[name=place]:checked').val();
            let row = parseInt(place.split(",")[0]);
            let cell = parseInt(place.split(",")[1]);
            let session = parseInt($('#hiddenSession').attr("value"));
            let arr = {row: row, cell: cell, session: session};
            $.ajax({
                cache: false,
                type: 'POST',
                url: '/cinema/index',
                data: JSON.stringify(arr),
                dataType: 'json',
                contentType: 'application/json'
            }).done(function(data) {
                if (data === "next") {
                    window.location.href='http://localhost:8080/cinema/payment.html';
                } else {
                    $("#commentRow").html('<div class=\"row pt-3\" id="commentRow">'
                        + '<h4>' + data + '</h4>'
                        + '</div>');
                    alert(data);
                }
            }).fail(function(err){
                alert(err);
            });
        }
        $(document).ready(function () {
            loadPlace();
            setInterval(function () {
                revalidateReserve();
            }, 60000);
        });
    </script>
    <script>
        function revalidateReserve() {
            $.ajax({
                cache: false,
                type: 'GET',
                url: '/cinema/index',
                dataType: 'json'
            }).done(function (data) {
                for (let i = 0; i < data.length; i++) {
                    let id = "" + data[i].row + data[i].cell;
                    if (data[i].isReserved) {
                        document.getElementById(id).disabled=true;
                    } else {
                        document.getElementById(id).disabled=false;
                    }
                }
                alert(data)
            }).fail(function (err) {
                console.log(err);
            });
        };
    </script>
    <script>
        function loadPlace() {
            $.ajax({
                cache: false,
                type: 'GET',
                url: '/cinema/index',
                dataType: 'json'
            }).done(function (data) {
                let body = "<tbody>";
                let result = "<table class=\"table table-bordered\" id=\"tablePlace\">";
                result += "<thead><tr>";
                result += "<th style=\"width: 120px;\">Ряд / Место</th>";
                let currentRow = 0;
                let maxCell = 0;
                for (let i = 0; i < data.length; i++) {
                    let place = data[i];
                    if (place.row !== currentRow) {
                        currentRow++;
                    }
                    body += "<tr><th>" + place.row + "</th>"
                    let currentCell = i;
                    while (place.row === currentRow) {
                        if (place.cell > maxCell) {
                            result += "<th>" + place.cell + "</th>";
                            maxCell++;
                        }
                        let row = place.row;
                        let cell = place.cell;
                        body += "<td><input type=\"radio\" id=\"" + row + cell + "\" ";
                        if (place.isReserved) {
                            body += "disabled ";
                        }
                        body += "name=\"place\" value=\"" + row + "," + cell + "\"> Ряд"
                           + row + ", Место" + cell + "</td>"
                        if (++currentCell === data.length) {
                            break;
                        }
                        place = data[currentCell];
                    }
                    body += "<tr>"
                    i = currentCell - 1;
                }
                result += "</tr></thead>";
                body += "</tbody>";
                body += "</table>";
                result += body;
                $("#tablePlace").html(result);
                console.log(data);
            }).fail(function (err) {
                console.log(err);
            });
        };
    </script>
</head>
<body>

<div class="container">
    <div class="row pt-3">
        <h4>
            Бронирование места на сеанс
        </h4>
        <table class="table table-bordered" id="tablePlace">
        </table>
    </div>
    <div class="row float-right" id="buttonId">
        <button type="button" class="btn btn-success" onclick="sendPlaces()">Выбрать</button>
        <input type="hidden" value="1" id="hiddenSession" class="hiddenSession" name="hiddenSession">
    </div>
    <div class="row pt-3" id="commentRow">
    </div>
</div>
</body>
</html>